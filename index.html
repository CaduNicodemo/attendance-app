<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Attendance and Homework</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f2f2f2;
    margin: 0; padding: 0;
    display: flex; justify-content: center;
  }
  .container {
    max-width: 900px; width: 100%;
    padding: 20px; margin: 20px;
    background: #fff; border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  h1, h2, h3 { color: #333; }
  input, select, button { margin: 5px; padding: 5px 10px; }
  table { border-collapse: collapse; margin-top: 10px; width: 100%; }
  table, th, td { border: 1px solid #aaa; padding: 5px; text-align: center; }
  th { background: #e6e6e6; }
  tr:nth-child(even) { background: #fafafa; }
  .group-buttons { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px; }
  .group-button {
    flex: 1 1 calc(20% - 10px); min-width: 120px; max-width: 180px;
    padding: 10px; border-radius: 5px; border: 1px solid #555;
    cursor: pointer; text-align: center; font-weight: bold; color: white;
  }
  .overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.3);
    display: flex; justify-content: center; align-items: center;
    padding: 20px;
  }
  .overlay-content {
    background: white; padding: 20px; border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    max-width: 700px; width: 100%;
  }
  button:hover { opacity: 0.9; }
  .delete-group-btn {
    background:#d9534f; color:white; padding:10px 15px;
    border:none; border-radius:5px; cursor:pointer; margin-top:20px;
  }
  input[type="text"] { width: 95%; box-sizing: border-box; }
</style>
</head>
<body>
<div class="container">
  <h1>Attendance and Homework</h1>

  <h2>Criar Grupo</h2>
  <input id="groupName" placeholder="Nome do Grupo">
  <button id="addGroupBtn">Adicionar Grupo</button>
  <div class="group-buttons" id="groupsButtons"></div>

  <hr>

  <h3>Alunos</h3>
  <input id="studentName" placeholder="Nome do Aluno">
  <button id="addStudentBtn">Adicionar Aluno</button>
  <table id="studentsTable"><tr><th>Nome</th><th>Remover</th></tr></table>

  <hr>

  <h3>Aulas</h3>
  <div>
    <label><input type="checkbox" id="mon"> Segunda</label>
    <label><input type="checkbox" id="tue"> Terça</label>
    <label><input type="checkbox" id="wed"> Quarta</label>
    <label><input type="checkbox" id="thu"> Quinta</label>
    <label><input type="checkbox" id="fri"> Sexta</label>
  </div>
  <button id="generateClassesBtn">Gerar Aulas Futuras</button>
  <table id="classesTable"><tr><th>Data</th><th>Nome</th><th>Ações</th></tr></table>

  <hr>
  <button class="delete-group-btn" id="deleteGroupBtn">Excluir Grupo Atual</button>

  <hr>
  <div id="notificationSection" style="display:none;">
    <h3>Alunos Sinalizados</h3>
    <textarea id="flaggedMessage" rows="6" cols="80"></textarea><br>
    <button id="sendWhatsAppBtn">Enviar para WhatsApp</button>
  </div>
</div>

<script>
/* ---------------- Dados e inicialização ---------------- */
// tenta recuperar, ou cria estrutura padrão
let data;
try {
  data = JSON.parse(localStorage.getItem('teacherData')) || { groups: [] };
} catch(e) {
  data = { groups: [] };
}
let currentGroupIndex = 0;

function saveData(){
  localStorage.setItem('teacherData', JSON.stringify(data));
}

/* ---------------- Helpers ---------------- */
function todayISO(){
  return new Date().toISOString().slice(0,10);
}
function isHoliday(dateStr){
  const holidays = [
    "2025-01-01","2025-02-25","2025-04-18","2025-04-21","2025-05-01",
    "2025-06-19","2025-09-07","2025-10-12","2025-11-02","2025-11-15",
    "2025-12-25", "2025-01-25" // SP municipal
  ];
  return holidays.includes(dateStr);
}

/* ---------------- Normalização (compatibilidade) ---------------- */
function normalizeData(){
  if(!data.groups) data.groups = [];
  data.groups.forEach(g=>{
    if(!Array.isArray(g.students)) g.students = [];
    if(!Array.isArray(g.classes)) g.classes = [];
    g.classes.forEach(c=>{
      // ensure records is array
      if(!Array.isArray(c.records)) c.records = [];
      // ensure each record has attendance/homework fields
      c.records.forEach(r=>{
        if(typeof r.attendance === 'undefined') r.attendance = false;
        if(typeof r.homework  === 'undefined') r.homework  = false;
      });
      // completed flag default false
      if(typeof c.completed === 'undefined') c.completed = !!(c.records && c.records.some(r=>r.attendance===true || r.homework===true));
    });
  });
}
normalizeData();

/* ---------------- Grupos ---------------- */
function createGroup(){
  const name = document.getElementById("groupName").value.trim();
  if(!name) return alert("Digite o nome do grupo");
  data.groups.push({ name, students:[], classes:[], days:[] });
  saveData();
  document.getElementById("groupName").value="";
  renderGroupButtons();
  selectGroup(data.groups.length-1);
}
function renderGroupButtons(){
  const container = document.getElementById("groupsButtons");
  container.innerHTML="";
  data.groups.forEach((g,i)=>{
    const btn = document.createElement("div");
    btn.className="group-button";
    btn.style.backgroundColor = `hsl(200,60%,${40+40*(i/Math.max(data.groups.length-1,1))}%)`;
    btn.innerText = g.name;
    btn.addEventListener("click", ()=>selectGroup(i));
    container.appendChild(btn);
  });
}
function selectGroup(i){
  currentGroupIndex = i;
  renderStudents();
  renderClasses();
  checkFlags();
}
function deleteGroup(){
  if(!data.groups[currentGroupIndex]) return;
  if(confirm(`Excluir grupo "${data.groups[currentGroupIndex].name}"?`)){
    data.groups.splice(currentGroupIndex,1);
    currentGroupIndex=0;
    saveData();
    renderGroupButtons();
    if(data.groups.length>0) selectGroup(0);
    else {
      document.getElementById("studentsTable").innerHTML="<tr><th>Nome</th><th>Remover</th></tr>";
      document.getElementById("classesTable").innerHTML="<tr><th>Data</th><th>Nome</th><th>Ações</th></tr>";
      document.getElementById("notificationSection").style.display="none";
    }
  }
}

/* ---------------- Alunos ---------------- */
function addStudent(){
  const name = document.getElementById("studentName").value.trim();
  if(!name) return alert("Digite o nome do aluno");
  const g = data.groups[currentGroupIndex];
  g.students.push({name});
  // adiciona aluno nas aulas futuras (a partir de hoje)
  const hoje = todayISO();
  g.classes.forEach(c=>{
    if(c.date >= hoje && !c.records.find(r=>r.name===name)){
      c.records.push({ name, attendance:false, homework:false });
    }
  });
  saveData();
  document.getElementById("studentName").value="";
  renderStudents();
  renderClasses();
}
function removeStudent(index){
  const g = data.groups[currentGroupIndex];
  const removed = g.students.splice(index,1)[0];
  // remove dos registros também (para manter consistência)
  g.classes.forEach(c=>{
    c.records = c.records.filter(r=>r.name !== removed.name);
  });
  saveData();
  renderStudents();
  renderClasses();
}
function renderStudents(){
  const g = data.groups[currentGroupIndex];
  const t = document.getElementById("studentsTable");
  t.innerHTML=`<tr><th colspan="2">${g ? g.name : ""}</th></tr><tr><th>Nome</th><th>Remover</th></tr>`;
  if(!g) return;
  g.students.forEach((s,i)=>{
    const row = t.insertRow();
    row.insertCell(0).innerText=s.name;
    const btnCell=row.insertCell(1);
    const btn=document.createElement("button");
    btn.innerText="Remover";
    btn.addEventListener("click", ()=>removeStudent(i));
    btnCell.appendChild(btn);
  });
}

/* ---------------- Gerar Aulas ---------------- */
function generateClasses(){
  const g = data.groups[currentGroupIndex];
  if(!g) return alert("Selecione/abra um grupo primeiro");
  g.days = [];
  if(document.getElementById("mon").checked) g.days.push(1);
  if(document.getElementById("tue").checked) g.days.push(2);
  if(document.getElementById("wed").checked) g.days.push(3);
  if(document.getElementById("thu").checked) g.days.push(4);
  if(document.getElementById("fri").checked) g.days.push(5);

  if(g.days.length===0) return alert("Selecione os dias da semana");

  let d = new Date();
  let end = new Date(new Date().getFullYear(),11,31);

  while(d<=end){
    const day = d.getDay(); // 0=Dom,1=Seg,...
    const dateStr = d.toISOString().slice(0,10);
    if(g.days.includes(day) && !isHoliday(dateStr)){
      if(!g.classes.find(c=>c.date===dateStr)){
        g.classes.push({
          date: dateStr,
          name: dateStr,
          completed: false, // só terá true quando alguém salvar essa aula
          records: g.students.map(s=>({ name: s.name, attendance:false, homework:false }))
        });
      } else {
        // se já existe, garantia compatibilidade (colocar alunos faltantes)
        const c = g.classes.find(x=>x.date===dateStr);
        g.students.forEach(s=>{
          if(!c.records.some(r=>r.name===s.name)){
            c.records.push({ name: s.name, attendance:false, homework:false });
          }
        });
      }
    }
    d.setDate(d.getDate()+1);
  }
  g.classes.sort((a,b)=>a.date.localeCompare(b.date));
  saveData();
  renderClasses();
}

/* ---------------- Render Classes (com input editável no nome) ---------------- */
function renderClasses(){
  const g = data.groups[currentGroupIndex];
  const t = document.getElementById("classesTable");
  t.innerHTML=`<tr><th>Data</th><th>Nome</th><th>Ações</th></tr>`;
  if(!g) return;
  g.classes.forEach((c,i)=>{
    const row = t.insertRow();
    row.insertCell(0).innerText = c.date;
    // input editável direto na tabela
    const nameCell = row.insertCell(1);
    const inp = document.createElement("input");
    inp.type = "text";
    inp.value = c.name || c.date;
    inp.addEventListener('change', (e)=>{
      c.name = e.target.value.trim() || c.date;
      saveData();
      // atualiza valor formatado
      e.target.value = c.name;
    });
    nameCell.appendChild(inp);

    const cell = row.insertCell(2);
    const mark = document.createElement("button");
    mark.innerText = "Marcar";
    mark.addEventListener("click", ()=>openClass(i));
    const del = document.createElement("button");
    del.innerText = "Excluir";
    del.addEventListener("click", ()=>deleteClass(i));
    cell.appendChild(mark);
    cell.appendChild(del);
  });
}

/* ---------------- Overlay (abrir aula e pegar dados) ---------------- */
function openClass(classIndex){
  const g = data.groups[currentGroupIndex];
  const cls = g.classes[classIndex];
  if(!cls) return;

  // normaliza records: garante que todos os alunos existam no registro dessa aula
  if(!Array.isArray(cls.records)) cls.records = [];
  // adicionar alunos faltantes (apenas para aulas >= hoje)
  const hoje = todayISO();
  g.students.forEach(s=>{
    if(!cls.records.some(r=>r.name===s.name)){
      // adiciona apenas para aulas que não são do passado (se quiser outro comportamento, me fala)
      if(cls.date >= hoje){
        cls.records.push({ name: s.name, attendance:false, homework:false });
      } else {
        // para aulas do passado, adiciona também, mas sem marcar nada
        cls.records.push({ name: s.name, attendance:false, homework:false });
      }
    }
  });
  // garantir campos
  cls.records.forEach(r=>{
    if(typeof r.attendance === 'undefined') r.attendance = false;
    if(typeof r.homework === 'undefined') r.homework = false;
  });

  // monta overlay HTML (ids únicos por classIndex para evitar colisão)
  let html = `<h3>Marcar Aula: ${cls.date}</h3>
    <label style="display:block; margin-bottom:8px;">Nome da Aula:
      <input type="text" id="classNameInput" value="${escapeHtml(cls.name || cls.date)}" autocomplete="off" autofocus>
    </label>
    <table border="1" style="width:100%; margin-top:10px;">
      <tr><th>Aluno</th><th>Presença</th><th>Lição</th></tr>`;

  cls.records.forEach((r,i)=>{
    // ids incluem classIndex para ficar únicos
    const attId = `att_${classIndex}_${i}`;
    const hwId  = `hw_${classIndex}_${i}`;
    html += `<tr>
      <td>${escapeHtml(r.name)}</td>
      <td><input type="checkbox" id="${attId}" ${r.attendance ? "checked":""}></td>
      <td><input type="checkbox" id="${hwId}" ${r.homework ? "checked":""}></td>
    </tr>`;
  });

  html += `</table>
    <div style="margin-top:10px;">
      <button id="saveBtn">Salvar</button>
      <button id="cancelBtn">Cancelar</button>
    </div>`;

  const div = document.createElement('div');
  div.className = "overlay-content";
  div.innerHTML = html;
  const overlay = document.createElement('div');
  overlay.className = "overlay";
  overlay.appendChild(div);
  document.body.appendChild(overlay);

  // listeners sem usar window
  document.getElementById('saveBtn').addEventListener('click', ()=>saveClass(classIndex));
  document.getElementById('cancelBtn').addEventListener('click', cancelOverlay);
  // foco no input do nome
  const nameInput = document.getElementById('classNameInput');
  if(nameInput) nameInput.focus();
}

/* ---------------- Salvar aula (marca completed) ---------------- */
function saveClass(classIndex){
  const g = data.groups[currentGroupIndex];
  const cls = g.classes[classIndex];
  if(!cls) return;

  const nameInput = document.getElementById('classNameInput');
  if(nameInput) cls.name = nameInput.value.trim() || cls.date;

  cls.records.forEach((r,i)=>{
    const att = document.getElementById(`att_${classIndex}_${i}`);
    const hw  = document.getElementById(`hw_${classIndex}_${i}`);
    if(att) r.attendance = att.checked;
    if(hw)  r.homework   = hw.checked;
  });

  // marca aula como preenchida
  cls.completed = true;

  saveData();
  renderClasses();
  checkFlags();
  cancelOverlay();
  alert("Aula salva!");
}
function cancelOverlay(){
  const overlay = document.querySelector('.overlay');
  if(overlay) overlay.remove();
}

/* ---------------- Flags (usar apenas aulas completed até hoje) ---------------- */
function checkFlags(){
  const g = data.groups[currentGroupIndex];
  if(!g) return;
  const today = todayISO();
  const filledClasses = g.classes.filter(c => c.date <= today && c.completed);
  if(filledClasses.length < 2){
    document.getElementById("notificationSection").style.display = "none";
    return;
  }
  const lastTwo = filledClasses.slice(-2);
  const flagged = [];
  g.students.forEach(s=>{
    const recs = lastTwo.map(c => c.records.find(r => r.name === s.name) || {attendance:false, homework:false});
    const abs = recs.map(r => !!(r.attendance === true)); // true if present
    const hw  = recs.map(r => !!(r.homework === true));
    let reason = "";
    if(!abs[0] && !abs[1]) reason += "Faltou 2 aulas; ";
    if(!hw[0] && !hw[1]) reason += "Não entregou lição 2x; ";
    if(reason) flagged.push({ name: s.name, reason, dates: lastTwo.map(c=>c.date) });
  });

  if(flagged.length>0){
    document.getElementById("notificationSection").style.display = "block";
    let msg = `${g.name} - Alunos Sinalizados:\n`;
    flagged.forEach(f => { msg += `${f.name} - ${f.reason}Datas: ${f.dates.join(", ")}\n`; });
    document.getElementById("flaggedMessage").value = msg;
  } else {
    document.getElementById("notificationSection").style.display = "none";
  }
}

/* ---------------- WhatsApp ---------------- */
function sendWhatsApp(){
  const phone = "+5511991463208";
  const text = encodeURIComponent(document.getElementById("flaggedMessage").value);
  const url = `https://wa.me/${phone.replace(/\D/g,'')}?text=${text}`;
  window.open(url, "_blank");
}

/* ---------------- Util ---------------- */
function escapeHtml(str){
  return String(str ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

/* ---------------- Init listeners ---------------- */
document.getElementById("addGroupBtn").addEventListener("click", createGroup);
document.getElementById("addStudentBtn").addEventListener("click", addStudent);
document.getElementById("deleteGroupBtn").addEventListener("click", deleteGroup);
document.getElementById("generateClassesBtn").addEventListener("click", generateClasses);
document.getElementById("sendWhatsAppBtn").addEventListener("click", sendWhatsApp);

/* ---------------- Render inicial ---------------- */
renderGroupButtons();
if(data.groups.length>0) selectGroup(0);
</script>
</body>
</html>