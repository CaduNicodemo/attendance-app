<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance and Homework</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
    }
    .container {
        max-width: 900px;
        width: 100%;
        padding: 20px;
        background-color: #ffffff;
        margin: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    h1, h2, h3 { color: #333333; }
    input, select, button { margin: 5px; padding: 5px 10px; }
    table { border-collapse: collapse; margin-top: 10px; width: 100%; }
    table, th, td { border: 1px solid #aaa; padding: 5px; text-align: center; }
    th { background-color: #e6e6e6; }
    tr:nth-child(even) { background-color: #fafafa; }
    .flagged { background-color: #ffcccc; }
    .group-buttons {
    margin: 10px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: flex-start; /* align to left or center if you prefer */
}

.group-button {
    flex: 1 1 calc(20% - 10px); /* five buttons per row minus gap */
    min-width: 120px; /* ensures buttons are not too narrow on small screens */
    max-width: 180px; /* optional, prevents extremely large buttons on wide screens */
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #555;
    cursor: pointer;
    text-align: center;
    font-weight: bold;
    color: white;
    box-sizing: border-box;
}
    .overlay {
        position: fixed; top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.3);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    .overlay-content {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        max-width: 600px;
        width: 100%;
    }
    button:hover { opacity: 0.9; }
</style>
</head>
<body>
<div class="container">
<h1>Attendance and Homework</h1>

<!-- Create group -->
<h2>Create Group</h2>
<input id="groupName" placeholder="Group Name">
<button onclick="createGroup()">Add Group</button>

<div class="group-buttons" id="groupsButtons"></div>

<hr>

<!-- Students -->
<h3>Students</h3>
<input id="studentName" placeholder="Student Name">
<button onclick="addStudent()">Add Student</button>
<table id="studentsTable">
<tr><th>Name</th><th>Remove</th></tr>
</table>

<hr>

<!-- Classes -->
<h3>Classes</h3>
<input type="date" id="classDate">
<button onclick="addClass()">Add Class</button>
<table id="classesTable">
<tr><th>Date</th><th>Actions</th></tr>
</table>

<hr>

<button style="background-color:#d9534f;color:white;padding:10px 15px;border:none;border-radius:5px;cursor:pointer;" onclick="deleteGroup()">Delete Current Group</button>

<hr>

<!-- Flagged students -->
<div id="notificationSection" style="display:none;">
<h3>Flagged Students</h3>
<textarea id="flaggedMessage" rows="6" cols="80"></textarea><br>
<button onclick="sendWhatsApp()">Send to WhatsApp</button>
</div>
</div>

<script>
// ----- Data -----
let data = JSON.parse(localStorage.getItem('teacherData')) || { groups: [] };
let currentGroupIndex = 0;

// ----- Save -----
function saveData() { localStorage.setItem('teacherData', JSON.stringify(data)); }

// ----- Groups -----
function createGroup() {
    const name = document.getElementById('groupName').value.trim();
    if(!name) return alert("Enter group name");
    data.groups.push({ name, students: [], classes: [] });
    saveData();
    document.getElementById('groupName').value = '';
    renderGroupButtons();
    selectGroup(data.groups.length-1);
}

function renderGroupButtons() {
    const container = document.getElementById('groupsButtons');
    container.innerHTML = '';
    const baseHue = 200; // blue shades
    const total = data.groups.length;
    data.groups.forEach((g,i)=>{
        const btn = document.createElement('div');
        const lightness = 40 + 40*(i/Math.max(total-1,1));
        const color = `hsl(${baseHue},60%,${lightness}%)`;
        btn.style.backgroundColor = color;
        btn.className = 'group-button';
        btn.innerText = g.name;
        btn.onclick = ()=>selectGroup(i);
        container.appendChild(btn);
        // store the color in the group object for table use
        g.color = color;
    });
}

function selectGroup(index) {
    currentGroupIndex = index;
    renderStudents();
    renderClasses();
    checkFlags();
}

// ----- Students -----
function addStudent() {
    const name = document.getElementById('studentName').value.trim();
    if(!name) return alert("Enter student name");
    const group = data.groups[currentGroupIndex];
    group.students.push({ name });
    saveData();
    document.getElementById('studentName').value = '';
    renderStudents();
}

function removeStudent(index) {
    const group = data.groups[currentGroupIndex];
    group.students.splice(index,1);
    saveData();
    renderStudents();
}


function renderStudents() {
    const table = document.getElementById('studentsTable');
    table.innerHTML = `<tr><th colspan="2" style="background-color:${data.groups[currentGroupIndex].color}; color:white; font-size:16px;">${data.groups[currentGroupIndex].name}</th></tr><tr><th>Name</th><th>Remove</th></tr>`;
    const group = data.groups[currentGroupIndex];
    group.students.forEach((s,i)=>{
        const row = table.insertRow();
        row.insertCell(0).innerText = s.name;
        const btnCell = row.insertCell(1);
        const btn = document.createElement('button');
        btn.innerText = "Remove";
        btn.onclick = ()=>removeStudent(i);
        btnCell.appendChild(btn);
    });
}

// ----- Classes -----
function addClass() {
    const date = document.getElementById('classDate').value;
    if(!date) return alert("Pick a date");
    const group = data.groups[currentGroupIndex];
    if(group.classes.find(c=>c.date===date)) return alert("Class exists");
    const classObj = { date, records: group.students.map(s=>({ name: s.name, attendance:'present', homework:true })) };
    group.classes.push(classObj);
    saveData();
    renderClasses();
    checkFlags();
    document.getElementById('classDate').value='';
}

function deleteClass(index) {
    if(confirm("Delete this class?")) {
        const group = data.groups[currentGroupIndex];
        group.classes.splice(index,1);
        saveData();
        renderClasses();
        checkFlags();
    }
}

function renderClasses() {
    const table = document.getElementById('classesTable');
    table.innerHTML = `<tr><th colspan="2" style="background-color:${data.groups[currentGroupIndex].color}; color:white; font-size:16px;">${data.groups[currentGroupIndex].name}</th></tr><tr><th>Date</th><th>Actions</th></tr>`;
    const group = data.groups[currentGroupIndex];
    group.classes.forEach((c,i)=>{
        const row = table.insertRow();
        row.insertCell(0).innerText = c.date;
        const cell = row.insertCell(1);
        const markBtn = document.createElement('button');
        markBtn.innerText = "Mark";
        markBtn.onclick = ()=>markClass(i);
        const delBtn = document.createElement('button');
        delBtn.innerText = "Delete";
        delBtn.onclick = ()=>deleteClass(i);
        cell.appendChild(markBtn);
        cell.appendChild(delBtn);
    });
}

// ----- Overlay Marking -----
function markClass(classIndex) {
    const group = data.groups[currentGroupIndex];
    const cls = group.classes[classIndex];
    let html = "<h3>Mark Attendance & Homework for "+cls.date+"</h3><table border='1'><tr><th>Student</th><th>Attendance</th><th>Homework</th></tr>";
    cls.records.forEach((r,i)=>{
        html += "<tr><td>"+r.name+"</td>";
        html += "<td><select id='att_"+i+"'><option value='present' "+(r.attendance=='present'?'selected':'')+">Present</option><option value='absent' "+(r.attendance=='absent'?'selected':'')+">Absent</option></select></td>";
        html += "<td><select id='hw_"+i+"'><option value='true' "+(r.homework?'selected':'')+">Delivered</option><option value='false' "+(!r.homework?'selected':'')+">Not Delivered</option></select></td></tr>";
    });
    html += "</table><button onclick='saveClass("+classIndex+")'>Save</button> <button onclick='cancelOverlay()'>Cancel</button>";
    const div = document.createElement('div');
    div.innerHTML = html;
    div.className = 'overlay-content';

    const overlay = document.createElement('div');
    overlay.className = 'overlay';
    overlay.appendChild(div);
    document.body.appendChild(overlay);
}

function cancelOverlay() {
    document.body.removeChild(document.body.lastChild);
}

function saveClass(classIndex) {
    const group = data.groups[currentGroupIndex];
    const cls = group.classes[classIndex];
    cls.records.forEach((r,i)=>{
        r.attendance = document.getElementById('att_'+i).value;
        r.homework = document.getElementById('hw_'+i).value==='true';
    });
    saveData();
    renderClasses();
    checkFlags();
    alert("Class saved!");
    cancelOverlay();
}

// ----- Flags -----
function checkFlags() {
    const group = data.groups[currentGroupIndex];
    const classes = group.classes;
    if(classes.length<2){
        document.getElementById('notificationSection').style.display='none';
        return;
    }
    const flagged = [];
    group.students.forEach(s=>{
        const lastTwo = classes.slice(-2);
        const absences = lastTwo.map(c=>c.records.find(r=>r.name===s.name).attendance);
        const homeworks = lastTwo.map(c=>c.records.find(r=>r.name===s.name).homework);
        let reason = '';
        if(absences[0]=='absent' && absences[1]=='absent') reason += 'Missed 2 classes; ';
        if(!homeworks[0] && !homeworks[1]) reason += 'Homework not delivered 2x; ';
        if(reason) flagged.push({name:s.name, reason, dates:lastTwo.map(c=>c.date)});
    });
    if(flagged.length>0){
        document.getElementById('notificationSection').style.display='block';
        let msg = 'Flagged students:\n';
        flagged.forEach(f=>{ msg+=f.name+' - '+f.reason+'Dates: '+f.dates.join(', ')+'\n'; });
        document.getElementById('flaggedMessage').value = msg;
    } else {
        document.getElementById('notificationSection').style.display='none';
    }
}

// ----- WhatsApp -----
function sendWhatsApp() {
    const phone = "+5511991463208"; // your target number with country code
    const text = encodeURIComponent(document.getElementById('flaggedMessage').value);
    const url = `https://wa.me/${phone.replace(/\D/g,'')}?text=${text}`;
    window.open(url, '_blank');
}
function deleteGroup() {
    if(!data.groups[currentGroupIndex]) return;
    if(confirm(`Are you sure you want to delete the group "${data.groups[currentGroupIndex].name}"? This action cannot be undone.`)){
        data.groups.splice(currentGroupIndex,1);
        currentGroupIndex = 0;
        saveData();
        renderGroupButtons();
        if(data.groups.length>0) selectGroup(0);
        else {
            document.getElementById('studentsTable').innerHTML = "<tr><th>Name</th><th>Remove</th></tr>";
            document.getElementById('classesTable').innerHTML = "<tr><th>Date</th><th>Actions</th></tr>";
            document.getElementById('notificationSection').style.display='none';
        }
    }
}


// ----- Init -----
renderGroupButtons();
if(data.groups.length>0) selectGroup(0);

</script>
</body>
</html>
