<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Attendance and Homework</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background-color: #f2f2f2;
    margin: 0; padding: 0;
    display: flex; justify-content: center;
  }
  .container {
    max-width: 900px; width: 100%;
    padding: 20px; margin: 20px;
    background: #fff; border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
  }
  h1, h2, h3 { color: #333; }
  input, select, button { margin: 5px; padding: 5px 10px; }
  table { border-collapse: collapse; margin-top: 10px; width: 100%; }
  table, th, td { border: 1px solid #aaa; padding: 5px; text-align: center; }
  th { background: #e6e6e6; }
  tr:nth-child(even) { background: #fafafa; }
  .group-buttons { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px; }
  .group-button {
    flex: 1 1 calc(20% - 10px); min-width: 120px; max-width: 180px;
    padding: 10px; border-radius: 5px; border: 1px solid #555;
    cursor: pointer; text-align: center; font-weight: bold; color: white;
  }
  .group-button.dragging {
    opacity: 0.5;
  }
  .overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.3);
    display: flex; justify-content: center; align-items: center;
    padding: 20px;
  }
  .overlay-content {
    background: white; padding: 20px; border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.5);
    max-width: 700px; width: 100%;
  }
  button:hover { opacity: 0.9; }
  .delete-group-btn {
    background:#d9534f; color:white; padding:10px 15px;
    border:none; border-radius:5px; cursor:pointer; margin-top:20px;
  }
</style>
</head>
<body>
<div class="container">
  <h1>Attendance and Homework</h1>

  <h2>Criar Grupo</h2>
  <input id="groupName" placeholder="Nome do Grupo">
  <button id="addGroupBtn">Adicionar Grupo</button>
  <div class="group-buttons" id="groupsButtons"></div>

  <hr>

  <h3>Alunos</h3>
  <input id="studentName" placeholder="Nome do Aluno">
  <button id="addStudentBtn">Adicionar Aluno</button>
  <table id="studentsTable"><tr><th>Nome</th><th>Remover</th></tr></table>

  <hr>

  <h3>Aulas</h3>
  <div>
    <label><input type="checkbox" id="mon"> Segunda</label>
    <label><input type="checkbox" id="tue"> Terça</label>
    <label><input type="checkbox" id="wed"> Quarta</label>
    <label><input type="checkbox" id="thu"> Quinta</label>
    <label><input type="checkbox" id="fri"> Sexta</label>
  </div>
  <button id="generateClassesBtn">Gerar Aulas Futuras</button>
  <table id="classesTable"><tr><th>Data</th><th>Nome</th><th>Ações</th></tr></table>

  <hr>
  <button class="delete-group-btn" id="deleteGroupBtn">Excluir Grupo Atual</button>

  <hr>
  <div id="notificationSection" style="display:none;">
    <h3>Alunos Sinalizados</h3>
    <textarea id="flaggedMessage" rows="6" cols="80"></textarea><br>
    <button id="sendWhatsAppBtn">Enviar para WhatsApp</button>
  </div>
</div>

<script type="module">
/* ---------------- Firebase ---------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_AUTH_DOMAIN",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_STORAGE_BUCKET",
  messagingSenderId: "SEU_SENDER_ID",
  appId: "SEU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let data = { groups: [] };
let currentGroupIndex = 0;

/* ---------------- Helpers ---------------- */
function todayISO(){
  return new Date().toISOString().slice(0,10);
}
function escapeHtml(str){
  return String(str ?? "")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;")
    .replace(/"/g,"&quot;")
    .replace(/'/g,"&#039;");
}

/* ---------------- Grupos ---------------- */
async function createGroup(){
  const name = document.getElementById("groupName").value.trim();
  if(!name) return alert("Digite o nome do grupo");
  await addDoc(collection(db, "groups"), {
    name,
    students: [],
    classes: [],
    days: [],
    order: data.groups.length
  });
  document.getElementById("groupName").value="";
  renderGroupButtons();
}

async function deleteGroup(){
  if(!data.groups[currentGroupIndex]) return;
  if(confirm(`Excluir grupo "${data.groups[currentGroupIndex].name}"?`)){
    const g = data.groups[currentGroupIndex];
    await deleteDoc(doc(db, "groups", g.id));
    currentGroupIndex=0;
    renderGroupButtons();
  }
}

/* ---------------- Drag & Drop ---------------- */
async function renderGroupButtons() {
  const container = document.getElementById("groupsButtons");
  container.innerHTML = "";

  const q = query(collection(db, "groups"), orderBy("order"));
  const querySnapshot = await getDocs(q);

  data.groups = [];
  querySnapshot.forEach((docSnap, i) => {
    const g = { id: docSnap.id, ...docSnap.data() };
    data.groups.push(g);

    const btn = document.createElement("div");
    btn.className = "group-button";
    btn.style.backgroundColor = `hsl(200,60%,${40 + 40 * (i / Math.max(querySnapshot.size - 1, 1))}%)`;
    btn.innerText = g.name;
    btn.dataset.index = i;
    btn.draggable = true;

    btn.addEventListener("click", () => selectGroup(i));

    btn.addEventListener("dragstart", (e) => {
      e.dataTransfer.setData("text/plain", i);
      btn.classList.add("dragging");
    });

    btn.addEventListener("dragend", () => {
      btn.classList.remove("dragging");
    });

    btn.addEventListener("dragover", (e) => {
      e.preventDefault();
      btn.style.border = "2px dashed #000";
    });

    btn.addEventListener("dragleave", () => {
      btn.style.border = "";
    });

    btn.addEventListener("drop", async (e) => {
      e.preventDefault();
      btn.style.border = "";

      const fromIndex = parseInt(e.dataTransfer.getData("text/plain"));
      const toIndex = parseInt(btn.dataset.index);
      if (fromIndex === toIndex) return;

      const moved = data.groups.splice(fromIndex, 1)[0];
      data.groups.splice(toIndex, 0, moved);

      // atualizar ordem no Firestore
      for (let j = 0; j < data.groups.length; j++) {
        const g = data.groups[j];
        const ref = doc(db, "groups", g.id);
        await updateDoc(ref, { order: j });
      }

      renderGroupButtons();
    });

    container.appendChild(btn);
  });

  if(data.groups.length > 0) selectGroup(currentGroupIndex);
}

/* ---------------- Seleção ---------------- */
function selectGroup(i){
  currentGroupIndex = i;
  // aqui você chama renderStudents() e renderClasses() se já implementou
}

/* ---------------- Init ---------------- */
document.getElementById("addGroupBtn").addEventListener("click", createGroup);
document.getElementById("deleteGroupBtn").addEventListener("click", deleteGroup);

renderGroupButtons();
</script>
</body>
</html>